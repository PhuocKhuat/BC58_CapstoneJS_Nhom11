//M·ª§C 5. CH·ªåN S·∫¢N PH·∫®M TH√äM V√ÄO GI·ªé H√ÄNG.
// T·∫¢I L·∫†I TRANG ~ LOCALSTORAGE.
/**
 * B1. L·∫•y JSON l√™n t·ª´ LOCALSTORAGE.
 * B2. N·∫øu kh√°c null (kh√¥ng c√≥ gi√° tr·ªã, l√† c√≥ gi√° tr·ªã l·∫•y l√™n), chuy·ªÉn JSON th√†nh array v√¨ ch∆∞a s·ª≠ d·ª•ng ƒë∆∞·ª£c tr·ª±c ti·∫øp.
 * B3. L·∫•y array ƒëi x·ª≠ l√Ω ~ renderCart.
 */
// B1. T·∫°o 1 m·∫£ng gi·ªè h√†ng r·ªóng.
let cartArray = [];
let dataJson = localStorage.getItem('LOCAL_CARTARRAY');
//B2. N·∫øu kh√°c null (kh√¥ng c√≥ gi√° tr·ªã, l√† c√≥ gi√° tr·ªã l·∫•y l√™n), chuy·ªÉn JSON th√†nh array v√¨ ch∆∞a s·ª≠ d·ª•ng ƒë∆∞·ª£c tr·ª±c ti·∫øp.
if(dataJson != null){
  cartArray = JSON.parse(dataJson);
}
//B3. L·∫•y array ƒëi x·ª≠ l√Ω ~ renderCart.
renderCart(cartArray);

//TH√äM S·∫¢N PH·∫®M V√ÄO GI·ªé H√ÄNG ~ LOCALSTORAGE.
/**
 * B1. T·∫°o 1 m·∫£ng gi·ªè h√†ng r·ªóng.
 * B2. T·∫°o l·ªõp ƒë·ªëi t∆∞·ª£ng, th√™m thu·ªôc t√≠nh quantity.
 * B3. T·∫°o v√≤ng l·∫∑p for l·∫•y c√°c key trong l·ªõp ƒë·ªëi t∆∞·ª£ng.
 * B4. Th√™m v√†o m·∫£ng cartArray.
 * B5. Chuy·ªÉn array th√†nh JSON, v√¨ ch·ªâ c√≥ JSON m·ªõi l∆∞u xu·ªëng ƒë∆∞·ª£c LOCALSTORAGE.
 * B6. L∆∞u xu·ªëng LOCALSTORAGE.
 * B7. L·∫•y array ƒëi x·ª≠ l√Ω ti·∫øp.
 * B8. Khi ·∫•n th√™m t·∫°o spinner.
 */
// function themSP(){
//     //B2. T·∫°o l·ªõp ƒë·ªëi t∆∞·ª£ng, th√™m thu·ªôc t√≠nh quantity.
//     let itemImg = domID('product-img').src;
//     let itemNames = domID('product-name').innerText;
//     let itemQuantity = 1;
//     let itemId = domID('location').innerText;
//     let itemPrice = domID('product-price').innerText;
// //B3. T·∫°o v√≤ng l·∫∑p for l·∫•y c√°c key trong l·ªõp ƒë·ªëi t∆∞·ª£ng.
//   // for(let i =0; i< array.length; i++){
//     // const sP = array[i];
//     var cardItem1 = {
//        img: itemImg,
//        names: itemNames,
//        quantity: itemQuantity,
//        id: itemId,
//        price: itemPrice,
//     }; 
//     // }
//     // id: sP.id,
//     // names: sP.names,
//     // price: sP.price,
//     // img: sP.img,
//     // quantity: sP.quantity,
  
//   //B4. Th√™m v√†o m·∫£ng cartArray:
//     cartArray.push(cardItem1);
//     console.log("cartArray", cartArray);
//     //M·ª§C 7. N·∫æU CH∆ØA C√ì S·∫¢N PH·∫®M TH√å PUSH V√ÄO L√Ä 1, C√ì R·ªíI TH√å TƒÇNG L√äN 1. 
//     //B5. Chuy·ªÉn array th√†nh JSON ƒë·ªÉ l∆∞u xu·ªëng LOCALSTORAGE.
//     let dataJson = JSON.stringify(cartArray);
//     //B6. L∆∞u xu·ªëng LOCALSTORAGE.
//     localStorage.setItem('LOCAL_CARTARRAY', dataJson);
//     //B7. L·∫•y array ƒëi x·ª≠ l√Ω ti·∫øp.
//     renderCart(cartArray);
// }
//M·ª§C 13.
//XO√Å S·∫¢N PH·∫®M ~ LOCALSTORAGE (5 B∆Ø·ªöC).



//C·∫¨P NH·∫¨T GI√Å TI·ªÄN S·∫¢N PH·∫®M.
//C√ì CLASS KH√îNG X√ÅC ƒê·ªäNH ƒê∆Ø·ª¢C TH√å L·∫§Y PH·∫¶N T·ª¨ ƒê·∫¶U TI√äN TRONG M·∫¢NG.
/**
 * B1. Nh·ªØng class khi debugger kh√¥ng hi·ªán l·ªõp class th√¨ th√™m l·∫•y v·ªã tr√≠ ƒë·∫ßu ti√™n [0].
 * B2. Duy·ªát th·∫ª class l·ªõn nh·∫•t ch·ª©a t·∫•t c·∫£ c√°c d√≤ng, t·ªõi th·∫ª con ch·ª©a c√°c d√≤ng c·ªßa th·∫ª n√†y.
 * B3. Khai b√°o bi·∫øn total = 0.
 * B4. D√πng v√≤ng l·∫∑p for.
 * B5. Khai b√°o bi·∫øn b·∫±ng v·ªã tr√≠ th·ª© i trong m·∫£ng.
 * B6. Duy·ªát th·∫ª class c·ªßa ph·∫ßn t·ª≠ c·∫ßn t√≠nh (n·∫øu kh√¥ng th·∫•y class th√™m v·ªã tr√≠ [0]).
 * B7. L·∫•y gi√° tr·ªã c·ªßa ph·∫ßn t·ª≠ (input th√¨ .value, 2 th·∫ª ƒë√≥ng m·ªü th√¨ .innerText)
 * B8. C√¥ng th·ª©c t√≠nh total.
 * B9. dom ƒë·∫øn ch·ªó c·∫ßn ƒë·ªïi.
 */
function updatePriceAll() {
  const cartDiv = domCLASS('cart-items')[0]; //
  const cartTr = domCLASS('empty-cart');
  let total = 0;
  for(let i =0; i < cartTr.length; i++){
    const cartTrr = cartTr[i];
    const priceProduct = cartTrr.getElementsByClassName('priceProduct')[0];//
    const quantityProduct = cartTrr.getElementsByClassName('quantityProduct')[0];//
    const price = parseFloat(priceProduct.innerText);
    const quantity = quantityProduct.value;
    total += price*quantity;
  }
  domCLASS('total')[0].innerHTML = total; 
}

//SEARCH L·∫†I CHATGPT
//ƒêI·ªÄU CH·ªàNH S·ªê L∆Ø·ª¢NG (KI·ªÇM TRA L√Ä S·ªê, KH√îNG ƒê∆Ø·ª¢C √ÇM, TƒÇNG GI·∫¢M S·ªê L∆Ø·ª¢NG TƒÇNG GI·∫¢M GI√Å).
const quantityProduct = domCLASS('quantityProduct');
for(let i =0; i < quantityProduct.length; i++){
   let input = quantityProduct[i];
   //th√™m m·ªôt s·ª± ki·ªán change cho ph·∫ßn t·ª≠ input. Khi s·ª± ki·ªán change ƒë∆∞·ª£c k√≠ch ho·∫°t, h√†m quantityChanged() s·∫Ω ƒë∆∞·ª£c g·ªçi.
   input.addEventListener('change', quantityChanged)
}
function quantityChanged(event){
   let input = event.target;
   if(isNaN(input.value) || input.value <=0){
    input.value = 1;
   }
   updatePriceAll(); 
} 

//
<input type="number" class="w-14 h-7 p-2 sPcom quantityProduct" id="quantityProduct" value="${sP.quantity}"/>

function renderCart(cartArray){
  //B1. T·∫°o 1 chu·ªói r·ªóng.
  var contentHTML = "";
  //B2. T·∫°o 1 v√≤ng l·∫∑p for.
  for(i=0; i< cartArray.length; i++){
  //B3. Kh·ªüi t·∫°o bi·∫øn trung gian v√† g√°n b·∫±ng v·ªã tr√≠ i trong dSSP.
  let sP = cartArray[i];
  //B4. T·∫°o 1 chu·ªói string d√≤ng tr.
  //ƒê·ªÉ 1 th·∫ª bao b·ªçc c√°c object th√¨ td m·ªõi hi·ªÉu, gi√£n c√°ch c√°c √¥ ƒë∆∞·ª£c.
  let string = `
  <div class="cartDiv flex justify-evenly items-center">
  <tr class="cartTr col w-24">
    <td><img src="${sP.img}" class="w-16 sPcom" style="display: inline-block"/></td>
    <td><span class="sPcom">${sP.names}</span></td>
    <td><span class="sPcom units">
            <span class="btnMinus">-</span>  
            <span class="numberUnits">1</span>  
            <span class="btnPlus">+</span>  
        </span>
    </td>
    <td><span class="sPcom2">${sP.id}</span></td>
    <td><span class="sPcom3 priceProduct">${sP.price}</span></td>
    <td>
    <button class="btn btn-danger sPcom3" onclick="xoaSP('${sP.id}')">Clear</button>
    </td>
    <br>
  </tr>
  </div>
  `
  //B5. Chu·ªói r·ªóng += chu·ªói string.
  contentHTML += string;
  }
  //B6. dom l√™n giao di·ªán.
  // domCLASS('cart-items').innerHTML = contentHTML;
  domID('tblCart').innerHTML = contentHTML;
  }

  function changeUnits(action, id){
   let productIndex = cartArray.findIndex((item) => item.id === id);
   if(productIndex !== -1){
     let product = cartArray[productIndex];
     //N·∫øu nh·ªØng item trong cartArray n√†y tr√πng v·ªõi tham s·ªë id.
       if(action === 'minus' && product.quantity >1){ //ƒê·ªÉ >1 l√† 2 tr·ªü l√™n, khi gi·∫£m xu·ªëng 1.
        product.quantity--;
       } else if(action === 'plus' && product.quantity < product.instock){ //ƒê·ªÉ <9 l√† 8 tr·ªü xu·ªëng, khi tƒÉng l√™n 1 l√† 9.
        product.quantity++;
       }
   }
   capNhatSP();
}

const clearCart = () => {
  if(cartArray.length <= 0){
    tblCart.innerHTML = `<p class="text-center text-3xl text-red-600 my-6">There is no order. Please make a first order.</p>`;
    return;  
  }
  else if(cartArray.length > 1){
    cartArray.innerHTML = "";
  }
  capNhatSP();
}

const themSP = (id) => {
  //B6. S·ª≠ d·ª•ng SOME ƒë·ªÉ ki·ªÉm tra s·∫£n ph·∫©m d·ª±a theo id ƒë√£ t·ªìn t·∫°i hay ch∆∞a.
  if(cartArray.some((item) => item.id === id)){
    changeUnits('plus', id);
  }
  // 
  else{
    //B4. T√¨m s·∫£n ph·∫©m trong products ~ FIND.
      const item = products.find((product) => product.id === id)	;
    console.log("item", item);
    //B5. Th√™m s·∫£n ph·∫©m v√†o m·∫£ng r·ªóng, th√™m quantity.
    cartArray.push({
      ...item,
      quantity: 1,     
    });
    // console.log("cartArray", cartArray);
  }
  //B8. C·∫≠p nh·∫≠t b·∫£ng gi·ªè h√†ng.
  capNhatSP();
}

const themSP = (id)=>{
  axios({
    url: "https://653122dc4d4c2e3f333c71dd.mockapi.io/QDDT",
    method: "GET",
  })
  .then(function(res)  {
    console.log("üöÄ ~ .then ~ res:", res)
    products = res.data;
    console.log("üöÄ ~ .then ~ products:", products)
    if(cartArray.some((item) => item.id === id)){
      changeUnits('plus', id);
    }
    // 
    else{
      //B4. T√¨m s·∫£n ph·∫©m trong products ~ FIND.
        const item = products.find((product) => product.id === id)	;
      console.log("item", item);
      //B5. Th√™m s·∫£n ph·∫©m v√†o m·∫£ng r·ªóng, th√™m quantity.
      cartArray.push({
        ...item,
        quantity: 1,     
      });
      // console.log("cartArray", cartArray);
    }
    })
  .catch(function(err)  {
       console.log(err);
  });
}

const themSP = (id)=>{
  axios({
    url: "https://653e7b249e8bd3be29df5d3a.mockapi.io/cartItem",
    method: "GET",
  })
  .then(function(res)  {
    console.log("üöÄ ~ .then ~ res:", res)
    if(cartArray.some((item) => item.id === id)){
      changeUnits('plus', id);
    }
    // 
    else{
      product = res.data;
      //B4. T√¨m s·∫£n ph·∫©m trong products ~ FIND.
        const item = product.find((product) => product.id*1 === id);
      console.log("item", item);
      //B5. Th√™m s·∫£n ph·∫©m v√†o m·∫£ng r·ªóng, th√™m quantity.
      cartArray.push({
        ...item,
        quantity: 1,     
      });
      // console.log("cartArray", cartArray);
    }
    capNhatSP();
    })
  .catch(function(err)  {
       console.log(err);
  });
}

let index = cartArray.findIndex(item => item.id === id);
      if (index === -1) {
        let product = res.data;
        cartArray.push({
          ...product,
          quantity: 1,
        });
      }
      //
      else {
        changeUnits("plus", id);
        //B5. Th√™m s·∫£n ph·∫©m v√†o m·∫£ng r·ªóng, th√™m quantity.
        // console.log("cartArray", cartArray);
      }
      capNhatSP();